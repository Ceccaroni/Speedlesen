<!doctype html>
<html lang="de">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Speedlesen – Start</title>
<link rel="stylesheet" href="./styles/base.css?v=10.1">
<body class="theme-warm">
<header class="container">
  <h1>Speedlesen – Start</h1>
  <nav>
    <button id="theme-toggle" class="btn-ghost" aria-pressed="false" title="Farbschema umschalten">Darstellung</button> 
    <a href="./erfassung.html">Erfassung</a>
    <a href="./dashboard.html">Dashboard</a>
  </nav>
</header>
<noscript><div class="container"><p style="border:1px solid #000;padding:8px"><strong>Hinweis:</strong> JavaScript ist deaktiviert. Diese Seite benötigt es für Erfassung und Auswertung.</p></div></noscript>

<main class="container">
  <section>
    <h2>Gruppen anlegen</h2>
    <p class="hint">Erfasse 1–3 Personen (Namen oder Kürzel, ASCII). Ergebnisse werden später pro Person eingegeben.</p>
    <form id="form-gruppe" autocomplete="off" class="grid-2">
      <div class="col-left">
      <label for="gruppe-name">Gruppenname</label>
      <input id="gruppe-name" name="gruppe-name" required maxlength="20" pattern="[A-Za-z0-9_-]{1,20}" placeholder="z. B. A1">

      <label for="anzahl-personen">Anzahl Personen</label>
      <select id="anzahl-personen" name="anzahl-personen">
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
      </select>

      </div>
      <div class="col-right">
      <div id="personen-container"></div>
      </div>

      </form>
  <div class="form-actions"><button id="btn-save-group" class="btn-primary">Gruppe speichern</button></div>
    </form>
  </section>

  <section>
    <h2>Einstellungen</h2>
    <div class="grid">
      <div class="card">
        <label for="mode">Punktesystem</label>
        <select id="mode">
          <option value="standard">Standard (A+B+C+D)</option>
          <option value="strikt">Strikt (nur A+B)</option>
        </select>
        <p class="hint">Gilt für diese Browser-Instanz. Wird lokal gespeichert.</p>
      </div>
    </div>
  </section>

  <section>
    <h2>Bestehende Gruppen</h2>
    <ul id="gruppenliste" class="list"></ul>
  </section>

<footer class="container"><small class="hint">Version v10.1</small></footer>
</main>

<script type="module">
  import { Store } from "./scripts/store.js?v=10.1";
  import { ui, q } from "./scripts/ui-utils.js?v=10.1";

  const store = new Store();
  await store.ready;

  const form = q('#form-gruppe');
  const btnSave = q('#btn-save-group');
  const anzahl = q('#anzahl-personen');
  const personenContainer = q('#personen-container');
  const liste = q('#gruppenliste');

  function renderPersonenfelder() {
    const n = parseInt(anzahl.value, 10);
    personenContainer.innerHTML = "";
    for (let i = 1; i <= n; i++) {
      const label = document.createElement('label');
      label.textContent = `Leser ${i} (Pseudonym, ASCII)`;
      const input = document.createElement('input');
      input.required = true;
      input.maxLength = 20;
      input.pattern = "[A-Za-z0-9_-]{1,20}";
      input.name = `leser_${i}`;
      input.placeholder = `z. B. L${i}`;
      personenContainer.append(label, input);
    }
  }
  anzahl.addEventListener('change', renderPersonenfelder);
  renderPersonenfelder();

  // (Enter) Tastendrücker abfangen
  form.addEventListener('submit', async (e) => { e.preventDefault(); btnSave?.click(); });

  btnSave.addEventListener('click', async (e) => {
    e.preventDefault();
    const name = q('#gruppe-name').value.trim(); if(!name){return;}
    const n = parseInt(anzahl.value, 10);
    const mitglieder = [];
    for (let i = 1; i <= n; i++) {
      const v = q(`[name="leser_${i}"]`).value.trim();
      if (!/^[A-Za-z0-9_-]{1,20}$/.test(v)) {
        alert("Pseudonyme: 1–20 Zeichen, ASCII [A–Z a–z 0–9 _ -]");
        return;
      }
      const pid = `${name}_${i}_${Date.now()}_${Math.random().toString(36).slice(2,8)}`;
      mitglieder.push({ id: `${name}_${i}`, pid, gruppe_id: name, alias: v });
    }
    await store.addGroup({ id: name, name });
    for (const m of mitglieder) await store.addMember(m);
    ui.toast("Gruppe gespeichert.");
    form.reset();
    q('#anzahl-personen').value = "2";
    renderPersonenfelder();
    await renderListe();
  });

  const MODE_KEY='speedlesen_mode';
  const modeSel = document.querySelector('#mode');
  if(modeSel){
    const saved = localStorage.getItem(MODE_KEY)||'standard';
    modeSel.value = saved;
    modeSel.addEventListener('change', ()=> localStorage.setItem(MODE_KEY, modeSel.value));
  }

  async function renderListe() {
    const gruppen = await store.getGroups();
    liste.innerHTML = "";
    for (const g of gruppen) {
      const li = document.createElement('li');
      li.innerHTML = `${g.id} — ${g.name} · <a href='./erfassung.html?gruppe=${g.id}'>Erfassung</a> · <a href='./dashboard.html?gruppe=${g.id}'>Dashboard</a>`;
      liste.appendChild(li);
    }
  }
  await renderListe();
</script>
<script>
  (function(){
    const key = "speedlesen_theme";
    const saved = localStorage.getItem(key);
    if (saved){ document.documentElement.dataset.theme = saved; }
    document.addEventListener("click", (e)=>{
      if (e.target && e.target.id==="theme-toggle"){
        const next = (document.documentElement.dataset.theme==="dark") ? "light" : "dark";
        document.documentElement.dataset.theme = next;
        localStorage.setItem(key, next);
        e.target.setAttribute("aria-pressed", next==="dark");
      }
    });
  })();
</script>
</body>
</html>
